<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">user-service</a> &gt; <a href="index.source.html" class="el_package">com.example.retailplatform.user.application.service</a> &gt; <span class="el_source">UserService.java</span></div><h1>UserService.java</h1><pre class="source lang-java linenums">package com.example.retailplatform.user.application.service;

import com.example.retailplatform.user.domain.UserConstants;
import com.example.retailplatform.user.domain.exception.ResourceAlreadyExistsException;
import com.example.retailplatform.user.domain.exception.ResourceNotFoundException;
import com.example.retailplatform.user.domain.model.Role;
import com.example.retailplatform.user.domain.model.Status;
import com.example.retailplatform.user.domain.model.User;
import com.example.retailplatform.user.domain.port.in.UserUseCase;
import com.example.retailplatform.user.domain.port.out.UserRepositoryPort;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.util.List;
import java.util.Optional;
import java.util.function.Function;

@Service
@RequiredArgsConstructor
public class UserService implements UserUseCase {

    private final UserRepositoryPort repositoryPort;

    // ------------------- Core Methods -------------------

    @Override
    public User createUser(User user) {
        // Set defaults
<span class="fc bfc" id="L29" title="All 2 branches covered.">        if (user.getStatus() == null) user.setStatus(Status.INACTIVE);</span>
<span class="fc bfc" id="L30" title="All 2 branches covered.">        if (user.getRole() == null) user.setRole(Role.USER);</span>
<span class="fc bfc" id="L31" title="All 2 branches covered.">        if (user.getActive() == null) user.setActive(true);</span>

        // Uniqueness checks using constants
<span class="fc" id="L34">        ensureUniqueGlobal(user.getUsername(), UserConstants.FIELD_USERNAME, UserConstants.USERNAME_ALREADY_EXISTS_KEY);</span>
<span class="fc" id="L35">        ensureUniqueActive(user.getEmail(), UserConstants.FIELD_EMAIL, repositoryPort::existsByActiveEmail, UserConstants.EMAIL_ALREADY_EXISTS_KEY);</span>
<span class="fc" id="L36">        ensureUniqueActive(user.getPhoneNumber(), UserConstants.FIELD_PHONE, repositoryPort::existsByActivePhoneNumber, UserConstants.PHONE_ALREADY_EXISTS_KEY);</span>

<span class="fc" id="L38">        return repositoryPort.save(user);</span>
    }

    @Override
    public User getUserById(String id) {
<span class="fc" id="L43">        return repositoryPort.findActiveById(id)</span>
<span class="fc" id="L44">                .orElseThrow(() -&gt; new ResourceNotFoundException(UserConstants.USER_NOT_FOUND_KEY));</span>
    }

    @Override
    public List&lt;User&gt; getAllUsers() {
<span class="nc" id="L49">        return repositoryPort.findAllActive();</span>
    }

    @Override
    public User updateUser(String id, User update) {
<span class="fc" id="L54">        User existing = getUserById(id);</span>
<span class="fc" id="L55">        update.setId(id);</span>

        // Update uniqueness checks using constants
<span class="fc" id="L58">        ensureUniqueGlobalForUpdate(update.getUsername(), existing.getId(), UserConstants.FIELD_USERNAME, UserConstants.USERNAME_ALREADY_EXISTS_KEY);</span>
<span class="fc" id="L59">        ensureUniqueActiveForUpdate(update.getEmail(), existing.getId(), repositoryPort::findActiveByEmail, UserConstants.FIELD_EMAIL, UserConstants.EMAIL_ALREADY_EXISTS_KEY);</span>
<span class="fc" id="L60">        ensureUniqueActiveForUpdate(update.getPhoneNumber(), existing.getId(), repositoryPort::findActiveByPhoneNumber, UserConstants.FIELD_PHONE, UserConstants.PHONE_ALREADY_EXISTS_KEY);</span>

        // Update fields
<span class="fc" id="L63">        copyFields(existing, update);</span>

<span class="fc" id="L65">        return repositoryPort.patch(existing);</span>
    }

    @Override
    public User patchUser(String id, User patch) {
<span class="fc" id="L70">        User existing = getUserById(id);</span>
<span class="fc" id="L71">        boolean changed = false;</span>

        // Patch fields with uniqueness
<span class="fc" id="L74">        changed |= patchField(existing::getUsername, existing::setUsername, patch.getUsername(),</span>
<span class="fc" id="L75">                val -&gt; ensureUniqueGlobalForUpdate(val, existing.getId(), UserConstants.FIELD_USERNAME, UserConstants.USERNAME_ALREADY_EXISTS_KEY));</span>

<span class="fc" id="L77">        changed |= patchField(existing::getEmail, existing::setEmail, patch.getEmail(),</span>
<span class="fc" id="L78">                val -&gt; ensureUniqueActiveForUpdate(val, existing.getId(), repositoryPort::findActiveByEmail,</span>
                        UserConstants.FIELD_EMAIL, UserConstants.EMAIL_ALREADY_EXISTS_KEY));

<span class="fc" id="L81">        changed |= patchField(existing::getPhoneNumber, existing::setPhoneNumber, patch.getPhoneNumber(),</span>
<span class="fc" id="L82">                val -&gt; ensureUniqueActiveForUpdate(val, existing.getId(), repositoryPort::findActiveByPhoneNumber,</span>
                        UserConstants.FIELD_PHONE, UserConstants.PHONE_ALREADY_EXISTS_KEY));

<span class="fc" id="L85">        changed |= patchField(existing::getFirstName, existing::setFirstName, patch.getFirstName(), null);</span>
<span class="fc" id="L86">        changed |= patchField(existing::getLastName, existing::setLastName, patch.getLastName(), null);</span>
<span class="fc" id="L87">        changed |= patchField(existing::getStatus, existing::setStatus, patch.getStatus(), null);</span>
<span class="fc" id="L88">        changed |= patchField(existing::getRole, existing::setRole, patch.getRole(), null);</span>
<span class="fc" id="L89">        changed |= patchField(existing::getActive, existing::setActive, patch.getActive(), null);</span>

<span class="pc bpc" id="L91" title="1 of 2 branches missed.">        return changed ? repositoryPort.patch(existing) : existing;</span>
    }

    @Override
    public void softDeleteUser(String id) {
<span class="fc" id="L96">        repositoryPort.softDelete(id); // only active users are affected</span>
<span class="fc" id="L97">    }</span>

    // ------------------- Helper Methods -------------------

    // --- Uniqueness checks ---

    private void ensureUniqueGlobal(String value, String fieldName, String key) {
<span class="pc bpc" id="L104" title="1 of 4 branches missed.">        if (value != null &amp;&amp; repositoryPort.existsByUsername(value)) {</span>
<span class="nc" id="L105">            throw new ResourceAlreadyExistsException(fieldName, key);</span>
        }
<span class="fc" id="L107">    }</span>

    private void ensureUniqueActive(String value, String fieldName, Function&lt;String, Boolean&gt; existsChecker, String key) {
<span class="pc bpc" id="L110" title="1 of 4 branches missed.">        if (value != null &amp;&amp; existsChecker.apply(value)) {</span>
<span class="nc" id="L111">            throw new ResourceAlreadyExistsException(fieldName, key);</span>
        }
<span class="fc" id="L113">    }</span>

    private void ensureUniqueGlobalForUpdate(String value, String currentUserId, String fieldName, String key) {
<span class="fc bfc" id="L116" title="All 2 branches covered.">        if (value != null) {</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">            if (repositoryPort.existsByUsername(value)) {</span>
<span class="fc" id="L118">                repositoryPort.findActiveByUsername(value)</span>
<span class="pc bpc" id="L119" title="1 of 2 branches missed.">                        .filter(u -&gt; !u.getId().equals(currentUserId))</span>
<span class="fc" id="L120">                        .ifPresent(u -&gt; {</span>
<span class="nc" id="L121">                            throw new ResourceAlreadyExistsException(fieldName, key);</span>
                        });
            }
        }
<span class="fc" id="L125">    }</span>

    private void ensureUniqueActiveForUpdate(String value, String currentUserId,
                                             Function&lt;String, Optional&lt;User&gt;&gt; finder,
                                             String fieldName, String key) {
<span class="fc bfc" id="L130" title="All 2 branches covered.">        if (value != null) {</span>
<span class="fc" id="L131">            finder.apply(value)</span>
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">                    .filter(u -&gt; !u.getId().equals(currentUserId))</span>
<span class="fc" id="L133">                    .ifPresent(u -&gt; {</span>
<span class="nc" id="L134">                        throw new ResourceAlreadyExistsException(fieldName, key);</span>
                    });
        }
<span class="fc" id="L137">    }</span>

    // --- Field copying ---
    private void copyFields(User existing, User update) {
<span class="fc" id="L141">        existing.setUsername(update.getUsername());</span>
<span class="fc" id="L142">        existing.setEmail(update.getEmail());</span>
<span class="fc" id="L143">        existing.setPhoneNumber(update.getPhoneNumber());</span>
<span class="fc bfc" id="L144" title="All 2 branches covered.">        existing.setFirstName(update.getFirstName() != null ? update.getFirstName() : existing.getFirstName());</span>
<span class="fc bfc" id="L145" title="All 2 branches covered.">        existing.setLastName(update.getLastName() != null ? update.getLastName() : existing.getLastName());</span>
<span class="fc bfc" id="L146" title="All 2 branches covered.">        existing.setStatus(update.getStatus() != null ? update.getStatus() : existing.getStatus());</span>
<span class="fc bfc" id="L147" title="All 2 branches covered.">        existing.setRole(update.getRole() != null ? update.getRole() : existing.getRole());</span>
<span class="fc bfc" id="L148" title="All 2 branches covered.">        existing.setActive(update.getActive() != null ? update.getActive() : existing.getActive());</span>
<span class="fc" id="L149">    }</span>

    // --- Generic patch helper ---
    private &lt;T&gt; boolean patchField(java.util.function.Supplier&lt;T&gt; getter,
                                   java.util.function.Consumer&lt;T&gt; setter,
                                   T newValue,
                                   java.util.function.Consumer&lt;T&gt; uniquenessCheck) {
<span class="fc bfc" id="L156" title="All 4 branches covered.">        if (newValue != null &amp;&amp; !newValue.equals(getter.get())) {</span>
<span class="fc bfc" id="L157" title="All 2 branches covered.">            if (uniquenessCheck != null) uniquenessCheck.accept(newValue);</span>
<span class="fc" id="L158">            setter.accept(newValue);</span>
<span class="fc" id="L159">            return true;</span>
        }
<span class="fc" id="L161">        return false;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>