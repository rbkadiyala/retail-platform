<?xml version="1.0" encoding="UTF-8"?>
<Configuration status="WARN" monitorInterval="30">
    <Properties>
        <Property name="LOG_DIR">${sys:LOG_PATH:-/app/logs}</Property>
        <Property name="SERVICE_NAME">user-service</Property>
    </Properties>

    <Appenders>
        <!-- One log file for everything -->
        <RollingFile name="UnifiedFileAppender"
                     fileName="${LOG_DIR}/${SERVICE_NAME}-combined.log"
                     filePattern="${LOG_DIR}/${SERVICE_NAME}-combined-%d{yyyy-MM-dd}-%i.log.gz">
            <PatternLayout pattern="%m%n"/>
            <Policies>
                <TimeBasedTriggeringPolicy interval="1" modulate="true"/>
                <SizeBasedTriggeringPolicy size="50 MB"/>
            </Policies>
        </RollingFile>

        <!-- JSON layout for your application logs -->
        <RollingFile name="JsonFileAppender"
                     fileName="${LOG_DIR}/${SERVICE_NAME}-combined.log"
                     filePattern="${LOG_DIR}/${SERVICE_NAME}-combined-%d{yyyy-MM-dd}-%i.log.gz"
                     append="true">
            <JsonTemplateLayout eventTemplateText='{
                "timestamp": "${json:timestamp}",
                "level": "${json:level}",
                "service": "${SERVICE_NAME}",
                "logger": "${json:loggerName}",
                "thread": "${json:threadName}",
                "correlationId": "${json:mdc:correlationId}",
                "traceId": "${json:mdc:traceId}",
                "spanId": "${json:mdc:spanId}",
                "message": "${json:message}",
                "exception": "${json:exception}"
            }'/>
            <Policies>
                <TimeBasedTriggeringPolicy interval="1" modulate="true"/>
                <SizeBasedTriggeringPolicy size="50 MB"/>
            </Policies>
        </RollingFile>
    </Appenders>

    <Loggers>
        <!-- JSON logs for your application code -->
        <Logger name="com.example.retailplatform" level="info" additivity="false">
            <AppenderRef ref="JsonFileAppender"/>
        </Logger>

        <!-- Plain text logs for everything else -->
        <Root level="info">
            <AppenderRef ref="UnifiedFileAppender"/>
        </Root>
    </Loggers>
</Configuration>
